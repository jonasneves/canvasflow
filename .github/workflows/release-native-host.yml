name: Release Native Host

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Release Native Host
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./native-host
        run: npm ci

      - name: Create distribution packages
        run: |
          # Create dist directory
          mkdir -p dist

          # Package for all platforms (cross-platform Node.js)
          cd native-host
          zip -r ../dist/canvasflow-native-host.zip \
            host.js \
            manifest.json \
            package.json \
            package-lock.json \
            install.sh \
            install.bat \
            README.md

          echo "Package created: canvasflow-native-host.zip"
          ls -lh ../dist/

      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/canvasflow-native-host.zip
          body: |
            ## CanvasFlow Native Host ${{ steps.version.outputs.version }}

            Download and install the native messaging host to connect Claude Desktop to your Canvas data.

            ### Installation

            1. Download `canvasflow-native-host.zip`
            2. Extract to a permanent location (e.g., `~/canvasflow-native-host` or `C:\Program Files\CanvasFlow`)
            3. Run `npm install` in the extracted directory
            4. Follow platform-specific setup instructions in README.md

            ### Requirements

            - Node.js 14 or higher
            - CanvasFlow Chrome extension installed

            ### What's Included

            - Native messaging host server (`host.js`)
            - MCP server configuration (`manifest.json`)
            - Installation instructions (`README.md`)
            - Node.js dependencies (`package.json`)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact (for manual runs)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: canvasflow-native-host-${{ steps.version.outputs.version }}
          path: dist/canvasflow-native-host.zip
          retention-days: 30
